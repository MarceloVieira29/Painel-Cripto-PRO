<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Painel Cripto PRO — 2 Gráficos + ST/MKR + IA + Contas</title>

<!-- ================== Estilos ================== -->
<style>
  :root{
    --bg:#0b1220;--panel:#0e1627;--soft:#111b2f;--muted:#334155;--text:#e5e7eb;
    --ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--line:#22304a;--info:#60a5fa
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{padding:16px;max-width:1680px;margin:auto}
  h1{margin:0 0 10px 0;font-size:18px;font-weight:700}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .topbar{background:var(--panel);border:1px solid #1f2a40;border-radius:12px;padding:10px}
  .chip{background:var(--soft);border:1px solid #243149;border-radius:10px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center;font-size:14px}
  .muted{color:#9aa8bf}
  select,input,button{background:#0b1220;color:var(--text);border:1px solid #2c3a52;border-radius:10px;padding:6px 10px}
  input{min-width:220px}
  button{cursor:pointer} button:hover{filter:brightness(1.12)}
  .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr;margin-top:12px}
  .card{background:var(--panel);border:1px solid #1f2a40;border-radius:12px;padding:12px;min-height:460px}
  .headRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .title{font-weight:700}
  .title .sub{font-weight:500;font-size:12px;color:#9aa8bf;margin-left:6px}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid #2b3750;font-size:12px;background:#0b1220}
  .b-green{border-color:#064e3b;color:#bbf7d0;background:#052e1a}
  .b-red{border-color:#7f1d1d;color:#fecaca;background:#3b0a0a}
  .b-yellow{border-color:#854d0e;color:#fde68a;background:#3a2a06}
  .b-blue{border-color:#1d4ed8;color:#dbeafe;background:#0b1e43}
  .chart{height:540px}
  .trendRow{display:flex;gap:8px;flex-wrap:wrap}
  .split{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  footer{margin-top:12px;color:#9aa8bf;font-size:12px;text-align:center}

  /* Modais */
  .mask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .modal{width:520px;max-width:92vw;background:var(--panel);border:1px solid #1f2a40;border-radius:14px;padding:16px}
  .modal h3{margin:0 0 10px 0}
  .vstack{display:flex;flex-direction:column;gap:8px}
  .hint{font-size:12px;color:#9aa8bf}
  .toast{position:fixed;left:16px;bottom:16px;background:#3a2a06;color:#fde68a;border:1px solid #854d0e;padding:8px 12px;border-radius:10px;display:none;z-index:25}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border:1px solid #1f2a40;padding:6px 8px}
  th{background:#0b1425}
</style>

<!-- ================== Charts ================== -->
<script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>

<!-- ================== Firebase compat (ordem importa) ================== -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<!-- ================== Firebase init ================== -->
<script>
  // Seu config
  const firebaseConfig = {
    apiKey: "AIzaSyAN70DLpn18XA11_JwjtkodpaOjquKEs3U",
    authDomain: "painel-cripto-pro.firebaseapp.com",
    projectId: "painel-cripto-pro",
    storageBucket: "painel-cripto-pro.firebasestorage.app",
    messagingSenderId: "897004329063",
    appId: "1:897004329063:web:b486598ff0f42fb52e5cc2",
    measurementId: "G-82VVH8YF7Y"
  };
  const _app = firebase.initializeApp(firebaseConfig);
  const _auth = firebase.auth();
  const _db   = firebase.firestore();
  window._fb  = { app:_app, auth:_auth, db:_db };

  // Helper para garantir que o Firebase está pronto antes de usar
  function waitForFirebase(){
    return new Promise((resolve,reject)=>{
      let tries=0;
      (function check(){
        if(window._fb && window._fb.auth && window._fb.db) return resolve(window._fb);
        if(++tries>200) return reject(new Error('Firebase não inicializou'));
        setTimeout(check,25);
      })();
    });
  }
</script>
</head>

<body>
<div class="wrap">
  <h1>Painel Cripto PRO — 2 Gráficos + Tendência (ST/MKR) + IA + Contas</h1>

  <!-- Topo -->
  <div class="topbar">
    <div class="split">
      <div class="row">
        <span class="muted">Cotações:</span>
        <span class="chip">BTC/BRL: <b id="q_btcbrl">—</b></span>
        <span class="chip">BTC/USDT: <b id="q_btcusdt">—</b></span>
        <span class="chip">USD/BRL: <b id="q_usdbrl">—</b></span>
        <span class="muted" id="lastTs">—</span>
      </div>
      <div class="row">
        <label class="chip">Auto:
          <select id="autoSel">
            <option value="0">Off</option>
            <option value="2000">2s</option>
            <option value="5000" selected>5s</option>
            <option value="10000">10s</option>
            <option value="15000">15s</option>
          </select>
        </label>
        <label class="chip">IA Webhook
          <input id="iaUrl" placeholder="https://seu-endpoint-ia/exec">
        </label>
        <label class="chip">Chave
          <input id="iaKey" placeholder="Bearer xxxxx (opcional)">
        </label>
        <label class="chip"><input type="checkbox" id="iaAuto" checked> IA em cada refresh</label>
        <button id="btnIaTest">Testar IA</button>

        <span class="chip">Sessão: <b id="sessStatus" class="muted">desconectado</b></span>
        <button id="btnOpenLogin">Entrar</button>
        <button id="btnLogout" style="display:none">Sair</button>
        <button id="btnAdmin" style="display:none">Admin</button>
      </div>
    </div>
  </div>

  <!-- Grids -->
  <div class="grid">
    <!-- L -->
    <div class="card">
      <div class="headRow">
        <div class="row"><span id="pairTitleL" class="title">—</span></div>
        <div class="row">
          <label class="chip">Moeda
            <select id="coinL"><option selected>BTC</option><option>ETH</option></select>
          </label>
          <label class="chip">Contra
            <select id="quoteL"><option>BRL</option><option selected>USDT</option></select>
          </label>
          <label class="chip">TF
            <select id="tfL">
              <option>1M</option><option selected>3M</option><option>5M</option><option>15M</option>
              <option>30M</option><option>1H</option><option>1D</option><option>1MO</option>
            </select>
          </label>
          <label class="chip">Velas
            <select id="lenL"><option>120</option><option selected>360</option><option>720</option><option>1200</option></select>
          </label>
        </div>
      </div>
      <div id="chartL" class="chart"></div>
      <div class="row" style="margin-top:10px">
        <div class="trendRow">
          <span class="badge b-yellow" id="tendL">Tendência: —</span>
          <span class="badge b-blue"   id="recL">Recomendação: —</span>
          <span class="badge" id="stBadgeL">ST: —</span>
          <span class="badge" id="mkrBadgeL">MKR: —</span>
          <span class="badge" id="atrBadgeL">ATR: —</span>
          <span class="badge" id="pctBadgeL">24h: —</span>
          <span class="badge" id="iaBadgeL">IA: —</span>
        </div>
      </div>
    </div>

    <!-- R -->
    <div class="card">
      <div class="headRow">
        <div class="row"><span id="pairTitleR" class="title">—</span></div>
        <div class="row">
          <label class="chip">Moeda
            <select id="coinR"><option selected>BTC</option><option>ETH</option></select>
          </label>
          <label class="chip">Contra
            <select id="quoteR"><option>BRL</option><option selected>USDT</option></select>
          </label>
          <label class="chip">TF
            <select id="tfR">
              <option>1M</option><option selected>3M</option><option>5M</option><option>15M</option>
              <option>30M</option><option>1H</option><option>1D</option><option>1MO</option>
            </select>
          </label>
          <label class="chip">Velas
            <select id="lenR"><option>120</option><option selected>360</option><option>720</option><option>1200</option></select>
          </label>
        </div>
      </div>
      <div id="chartR" class="chart"></div>
      <div class="row" style="margin-top:10px">
        <div class="trendRow">
          <span class="badge b-yellow" id="tendR">Tendência: —</span>
          <span class="badge b-blue"   id="recR">Recomendação: —</span>
          <span class="badge" id="stBadgeR">ST: —</span>
          <span class="badge" id="mkrBadgeR">MKR: —</span>
          <span class="badge" id="atrBadgeR">ATR: —</span>
          <span class="badge" id="pctBadgeR">24h: —</span>
          <span class="badge" id="iaBadgeR">IA: —</span>
        </div>
      </div>
    </div>
  </div>

  <footer>Painel Cripto Pro © 2025 — Desenvolvido por Marcelo. Para toda Honra e Glória do Senhor Jesus!</footer>
</div>

<!-- ===== Modal Login ===== -->
<div class="mask" id="loginMask">
  <div class="modal">
    <h3>Entrar</h3>
    <div class="vstack">
      <input id="inEmail" placeholder="seu@email.com"/>
      <input id="inPass"  placeholder="senha" type="password"/>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="btnCancelLogin">Cancelar</button>
      <button id="btnDoLogin">Entrar</button>
    </div>
    <p class="hint">Se não existir, a conta será criada automaticamente.</p>
  </div>
</div>

<!-- ===== Modal Admin (convites) ===== -->
<div class="mask" id="adminMask">
  <div class="modal">
    <h3>Admin — Convites</h3>
    <div class="vstack" style="margin-bottom:8px">
      <div class="row" style="flex-wrap:wrap">
        <input id="invEmail" placeholder="email do usuário">
        <select id="invRole">
          <option value="user" selected>user</option>
          <option value="admin">admin</option>
        </select>
        <button id="btnAddInvite">Adicionar convite</button>
      </div>
      <p class="hint">Usuários convidados: ao fazer login, recebem o papel do convite.</p>
    </div>
    <table id="tblInvites">
      <thead><tr><th>Email</th><th>Papel</th><th>Ações</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="btnCloseAdmin">Fechar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ================== App Script ================== -->
<script>
/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const fmtNum = (n,d=2)=>Number.isFinite(n)?n.toLocaleString('pt-BR',{minimumFractionDigits:d,maximumFractionDigits:d}):'—';
function toast(msg,ms=2500){const t=$('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',ms);}

/* ===== Binance + Indicadores ===== */
const tfMap={ '1M':'1m','3M':'3m','5M':'5m','15M':'15m','30M':'30m','1H':'1h','1D':'1d','1MO':'1M' };
const symbolOf=(c,q)=>(c+q).toUpperCase();

async function fetchTopQuotes(){
  try{
    const [pU,pB,usdt]=await Promise.all([
      fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT').then(r=>r.json()),
      fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCBRL').then(r=>r.json()),
      fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTBRL').then(r=>r.json()).catch(()=>({price:null}))
    ]);
    $('q_btcusdt').textContent=fmtNum(+pU.price,2)+' USDT';
    $('q_btcbrl').textContent=(+pB.price).toLocaleString('pt-BR');
    $('q_usdbrl').textContent=Number.isFinite(+usdt.price)?fmtNum(+usdt.price,2):'—';
    $('lastTs').textContent='Atualizado: '+new Date().toLocaleString('pt-BR');
  }catch{ $('lastTs').textContent='Atualizado: erro'; }
}
async function fetchKlines(symbol, interval, limit=360){
  const url=`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const arr=await fetch(url).then(r=>r.json());
  if(!Array.isArray(arr)||!arr.length) return [];
  return arr.map(k=>({time:Math.floor(k[0]/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4]}));
}
async function dayStats(symbol){
  try{const j=await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`).then(r=>r.json());
       const pct=j&&j.priceChangePercent!=null?+j.priceChangePercent:null; return {pct};}
  catch{return{pct:null}}
}
function rma(vals,len){const out=[];let p=null,a=1/len;for(let i=0;i<vals.length;i++){const v=vals[i];p=(p==null)?v:(p+a*(v-p));out.push(p)}return out}
function trueRange(h,l,cPrev){return Math.max(h-l,Math.abs(h-cPrev),Math.abs(l-cPrev))}
function calcSuperTrend(ohlc,len=10,mul=3){
  const n=ohlc.length;if(!n) return {dir:0,atr:0,line:[]};
  const tr=[];for(let i=0;i<n;i++){const cp=i>0?ohlc[i-1].close:ohlc[i].close;tr.push(trueRange(ohlc[i].high,ohlc[i].low,cp))}
  const atr=rma(tr,len);const st=new Array(n).fill(null),dir=new Array(n).fill(0);
  for(let i=0;i<n;i++){const o=ohlc[i],mid=(o.high+o.low)/2,ub=mid+mul*atr[i],lb=mid-mul*atr[i];
    if(i===0){st[i]=ub;dir[i]=-1;continue}
    const prevSt=st[i-1],prevDir=dir[i-1];
    if(prevDir===-1){const newUb=Math.min(ub,prevSt);st[i]=(o.close>newUb)?lb:newUb;dir[i]=(o.close>newUb)?+1:-1}
    else{const newLb=Math.max(lb,prevSt);st[i]=(o.close<newLb)?ub:newLb;dir[i]=(o.close<newLb)?-1:+1}
  }
  return {dir:dir[n-1],atr:atr[n-1],line:st}
}
function K(kernel,x,bw){const u=x/bw;return Math.exp(-0.5*u*u)/Math.sqrt(2*Math.PI)}
function mkrSmooth(arr,bw=14,dev=2){
  const n=arr.length;const mean=new Array(n),up=new Array(n),dn=new Array(n);
  for(let i=0;i<n;i++){let wsum=0,vsum=0,vsq=0;const left=Math.max(0,i-bw+1);
    for(let j=left;j<=i;j++){const w=K('Gaussian',i-j,bw/3);wsum+=w;vsum+=arr[j]*w;vsq+=arr[j]*arr[j]*w}
    const mu=vsum/wsum;const sd=Math.sqrt(Math.max(0,(vsq/wsum)-mu*mu));mean[i]=mu;up[i]=mu+dev*sd;dn[i]=mu-dev*sd}
  const slope=(n>1&&Number.isFinite(mean[n-1])&&Number.isFinite(mean[n-2]))?(mean[n-1]-mean[n-2]):0;
  return {mean,up,dn,slope,delta:slope}
}
function mkChart(id){
  const el=$(id);
  const chart=LightweightCharts.createChart(el,{layout:{background:{color:'#0e1627'},textColor:'#cbd5e1'},
    grid:{vertLines:{color:'#1f2a40'},horzLines:{color:'#1f2a40'}},rightPriceScale:{borderColor:'#1f2a40'},
    timeScale:{borderColor:'#1f2a40',timeVisible:true,secondsVisible:false},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
    handleScroll:{mouseWheel:true,pressedMouseMove:true},handleScale:{axisPressedMouseMove:true,mouseWheel:true,pinch:true},
    localization:{locale:'pt-BR'}});
  const candle=chart.addCandlestickSeries({upColor:'#16a34a',downColor:'#ef4444',borderVisible:false,wickUpColor:'#16a34a',wickDownColor:'#ef4444'});
  chart.timeScale().applyOptions({rightOffset:5,barSpacing:3});
  new ResizeObserver(()=>{const r=el.getBoundingClientRect();chart.resize(Math.floor(r.width),Math.floor(r.height))}).observe(el);
  return {chart,candle}
}
const L=mkChart('chartL'), R=mkChart('chartR');
function setDataPreserveView(series,chart,data){
  const ts=chart.timeScale(), atRight=Math.abs(ts.scrollPosition())<1e-2, vr=ts.getVisibleLogicalRange();
  series.setData(data); if(!atRight && vr){ ts.setVisibleLogicalRange(vr) } else { ts.scrollToRealTime() }
}
function pctClass(p){return p>0?'b-green':(p<0?'b-red':'b-yellow')}
function setBadge(el,text,cls){el.className='badge '+cls;el.textContent=text}
async function updatePairHeader(side,symbol,tf){
  const el=side==='L'?$('pairTitleL'):$('pairTitleR');
  try{
    const [px,day]=await Promise.all([
      fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`).then(r=>r.json()), dayStats(symbol)
    ]);
    const price=+px.price, pct=day.pct, pctTxt=(pct==null?'—':(pct>0?`+${pct.toFixed(2)}`:pct.toFixed(2))+'%'),
          pCls=pctClass(pct), quote=symbol.endsWith('USDT')?'USDT':'BRL',
          pairLabel=`${symbol.slice(0,-(quote==='USDT'?4:3))}/${quote}`;
    el.innerHTML=`${pairLabel} <span class="sub">(${tf})</span>
      <span class="badge">${quote==='USDT'?fmtNum(price,2)+' USDT':price.toLocaleString('pt-BR')+' BRL'}</span>
      <span class="badge ${pCls}" style="margin-left:6px">${pctTxt}</span>`;
    (side==='L'?$('pctBadgeL'):$('pctBadgeR')).className='badge '+pCls;
    (side==='L'?$('pctBadgeL'):$('pctBadgeR')).textContent='24h: '+pctTxt;
  }catch{ el.textContent=symbol+` (${tf})` }
}
function decideLocalAndBadges(side,data){
  if(!data.length){
    const ids=side==='L'?[ 'tendL','recL','stBadgeL','mkrBadgeL','atrBadgeL']:[ 'tendR','recR','stBadgeR','mkrBadgeR','atrBadgeR'];
    ids.forEach(id=>setBadge($(id),'—','')); (side==='L'?$('iaBadgeL'):$('iaBadgeR')).textContent='IA: —';
    return {tend:'Mista',rec:'Aguardar'}
  }
  const st=calcSuperTrend(data,10,3), closes=data.map(d=>d.close), mkr=mkrSmooth(closes,14,2);
  const dirST=st.dir, atr=st.atr, slope=mkr.slope;
  const stText=dirST>0?'ST: Alta':(dirST<0?'ST: Baixa':'ST: Neutra'), stCls=dirST>0?'b-green':(dirST<0?'b-red':'b-yellow');
  const mkrText=(slope>0?'MKR: ↑':(slope<0?'MKR: ↓':'MKR: →'))+`  Δ${fmtNum(mkr.delta,2)}`, mkrCls=slope>0?'b-green':(slope<0?'b-red':'b-yellow');
  const sameBear=(dirST<0&&slope<0), sameBull=(dirST>0&&slope>0);
  const tendencia=sameBull?'Alta':(sameBear?'Baixa':'Mista'), tendCls=sameBull?'b-green':(sameBear?'b-red':'b-yellow');
  let rec='Aguardar', recCls='b-blue'; if(sameBull){rec='Comprar (confluência)';recCls='b-green'} else if(sameBear){rec='Vender / reduzir';recCls='b-red'}
  if(side==='L'){ setBadge($('tendL'),`Tendência: ${tendencia}`,tendCls); setBadge($('recL'),`Recomendação: ${rec}`,recCls);
    setBadge($('stBadgeL'),stText,stCls); setBadge($('mkrBadgeL'),mkrText,mkrCls); setBadge($('atrBadgeL'),`ATR: ${fmtNum(atr,2)}`,'b-blue')}
  else { setBadge($('tendR'),`Tendência: ${tendencia}`,tendCls); setBadge($('recR'),`Recomendação: ${rec}`,recCls);
    setBadge($('stBadgeR'),stText,stCls); setBadge($('mkrBadgeR'),mkrText,mkrCls); setBadge($('atrBadgeR'),`ATR: ${fmtNum(atr,2)}`,'b-blue')}
  return {tend:tendencia,rec}
}
async function loadSide(side){
  const coin=(side==='L'?$('coinL').value:$('coinR').value),
        quote=(side==='L'?$('quoteL').value:$('quoteR').value),
        tfLbl=(side==='L'?$('tfL').value:$('tfR').value),
        len=(side==='L'?+$('lenL').value:+$('lenR').value),
        symbol=symbolOf(coin,quote), intv=tfMap[tfLbl];
  const data=await fetchKlines(symbol,intv,len);
  if(side==='L') setDataPreserveView(L.candle,L.chart,data); else setDataPreserveView(R.candle,R.chart,data);
  updatePairHeader(side,symbol,tfLbl); const local=decideLocalAndBadges(side,data);
  const iaOn=$('iaAuto').checked;
  if(iaOn && data.length){
    try{
      const url=$('iaUrl').value.trim(); if(url){
        const headers={'Content-Type':'application/json'}; const key=$('iaKey').value.trim(); if(key) headers['Authorization']=key;
        const resp=await fetch(url,{method:'POST',headers,body:JSON.stringify({symbol,tf:tfLbl,ohlc:data.slice(-120),local})}).then(r=>r.json());
        (side==='L'?$('iaBadgeL'):$('iaBadgeR')).textContent='IA: '+(resp?.advice||local.rec);
      }else{ (side==='L'?$('iaBadgeL'):$('iaBadgeR')).textContent='IA: '+local.rec }
    }catch{ (side==='L'?$('iaBadgeL'):$('iaBadgeR')).textContent='IA: '+local.rec }
  }else{ (side==='L'?$('iaBadgeL'):$('iaBadgeR')).textContent='IA: '+local.rec }
}
async function refreshAll(){ await fetchTopQuotes(); await Promise.all([loadSide('L'),loadSide('R')]) }
let timer=null; function setAuto(ms){ if(timer) clearInterval(timer); if(ms>0) timer=setInterval(refreshAll,ms) }
$('autoSel').onchange=()=>setAuto(+$('autoSel').value);
['coinL','quoteL','tfL','lenL'].forEach(id=>$(id).addEventListener('change',()=>loadSide('L')));
['coinR','quoteR','tfR','lenR'].forEach(id=>$(id).addEventListener('change',()=>loadSide('R')));
$('btnIaTest').onclick=async()=>{ try{ const url=$('iaUrl').value.trim(); if(!url) return toast('Informe a URL do IA');
  const h={'Content-Type':'application/json'}; const k=$('iaKey').value.trim(); if(k) h['Authorization']=k;
  const r=await fetch(url,{method:'POST',headers:h,body:JSON.stringify({ping:true,now:Date.now()})}).then(r=>r.json());
  toast('IA OK: '+(r?.message||r?.advice||'sucesso')); }catch(e){ toast('Falha IA: '+e.message) } };

/* ===== Auth + Perfis (Firestore) ===== */
let auth, db, userDocUnsub=null, invitesUnsub=null, isAdmin=false;

function setSessionUI(user){
  if(user){ $('sessStatus').textContent=user.email; $('btnOpenLogin').style.display='none'; $('btnLogout').style.display=''; }
  else{ $('sessStatus').textContent='desconectado'; $('btnOpenLogin').style.display=''; $('btnLogout').style.display='none'; $('btnAdmin').style.display='none'; isAdmin=false; }
}
$('btnOpenLogin').onclick=()=>{$('loginMask').style.display='flex';$('inEmail').focus()}
$('btnCancelLogin').onclick=()=>{$('loginMask').style.display='none'}
$('btnLogout').onclick=async()=>{ try{ await auth.signOut(); toast('Sessão encerrada'); }catch(e){ toast('Erro ao sair') } };
$('btnDoLogin').onclick=async()=>{
  const email=$('inEmail').value.trim(), pass=$('inPass').value;
  if(!email||!pass){toast('Informe e-mail e senha');return}
  try{
    await auth.signInWithEmailAndPassword(email,pass).catch(async err=>{
      if(err.code==='auth/user-not-found'){ await auth.createUserWithEmailAndPassword(email,pass); toast('Conta criada') }
      else throw err;
    });
    $('loginMask').style.display='none';
  }catch(e){ toast('Falha login: '+(e.message||e)) }
};

/* Admin modal */
const adminMask=$('adminMask'), tblBody=$('tblInvites').querySelector('tbody');
$('btnAdmin').onclick=()=>{ adminMask.style.display='flex' }
$('btnCloseAdmin').onclick=()=>{ adminMask.style.display='none' }
$('btnAddInvite').onclick=async()=>{
  try{
    const email=$('invEmail').value.trim().toLowerCase(), role=$('invRole').value;
    if(!email) return toast('Email vazio');
    await db.collection('invites').doc(email).set({role,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    $('invEmail').value=''; toast('Convite adicionado');
  }catch(e){ toast('Erro ao adicionar: '+e.message) }
};
function renderInvitesSnapshot(snap){
  tblBody.innerHTML='';
  snap.forEach(doc=>{
    const {role}=doc.data(); const tr=document.createElement('tr');
    tr.innerHTML=`<td>${doc.id}</td><td>${role}</td><td><button data-id="${doc.id}" class="rm">Remover</button></td>`;
    tblBody.appendChild(tr);
  });
  tblBody.querySelectorAll('button.rm').forEach(btn=>{
    btn.onclick=async()=>{ try{ await db.collection('invites').doc(btn.dataset.id).delete(); toast('Convite removido') }catch(e){ toast('Erro: '+e.message)} }
  });
}

/* Bootstrap de usuário: aplica convite se existir */
async function bootstrapUser(user){
  const uid=user.uid, email=user.email.toLowerCase();
  const userRef=db.collection('users').doc(uid);
  const doc=await userRef.get();
  if(!doc.exists){
    // tenta convite
    const inv=await db.collection('invites').doc(email).get();
    const role=inv.exists ? (inv.data().role||'user') : 'user';
    await userRef.set({email,role,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    if(inv.exists){ await inv.ref.delete() }
  }
}

/* Observadores */
async function startAuth(){
  await waitForFirebase(); auth=window._fb.auth; db=window._fb.db;

  auth.onAuthStateChanged(async (user)=>{
    setSessionUI(user);
    if(user){
      await bootstrapUser(user);
      // observa seu doc para saber se é admin
      userDocUnsub && userDocUnsub(); invitesUnsub && invitesUnsub();
      userDocUnsub = db.collection('users').doc(user.uid).onSnapshot(s=>{
        const role = s.exists ? (s.data().role||'user') : 'user';
        isAdmin = role==='admin';
        $('btnAdmin').style.display = isAdmin ? '' : 'none';
        // carrega lista de convites quando admin abre/está logado
        if(isAdmin){
          invitesUnsub = db.collection('invites').orderBy('createdAt','desc').onSnapshot(renderInvitesSnapshot);
        }else{
          invitesUnsub && invitesUnsub(); invitesUnsub=null; tblBody.innerHTML='';
        }
      });
    }else{
      userDocUnsub && userDocUnsub(); userDocUnsub=null;
      invitesUnsub && invitesUnsub(); invitesUnsub=null;
      tblBody.innerHTML='';
    }
  });
}

/* ===== Start ===== */
(async ()=>{
  await waitForFirebase();
  // presets
  $('coinL').value='BTC';$('quoteL').value='BRL';$('tfL').value='3M';$('lenL').value='360';
  $('coinR').value='BTC';$('quoteR').value='USDT';$('tfR').value='3M';$('lenR').value='360';
  await refreshAll(); setAuto(+$('autoSel').value);
  startAuth();
})();
</script>

<!--
==== Regras Firestore sugeridas (cole no Console, aba Rules) ====

rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    // cada usuário lê seu próprio doc
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if isAdmin();
    }
    // convites: admin gerencia; leitura aberta para ver se convite existe
    match /invites/{email} {
      allow read: if request.auth != null;   // opcional: pode deixar só admin ler
      allow write, delete: if isAdmin();
    }
    function isAdmin() {
      return request.auth != null
        && exists(/databases/$(db)/documents/users/$(request.auth.uid))
        && get(/databases/$(db)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
-->
</body>
</html>
