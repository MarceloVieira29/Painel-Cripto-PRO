<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin — Assinantes (Painel Cripto PRO)</title>
<style>
  :root{ --bg:#0b1220;--panel:#0e1627;--soft:#111b2f;--text:#e5e7eb;--line:#1f2a40;--ok:#22c55e;--bad:#ef4444 }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  h1{margin:0 0 12px 0;font-size:20px}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:12px}
  input,select,button{background:#0b1220;color:var(--text);border:1px solid #2c3a52;border-radius:10px;padding:6px 10px}
  button{cursor:pointer} button:hover{filter:brightness(1.12)}
  table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:14px}
  th{background:#101a2b;text-align:left}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:3px 8px;border-radius:999px;border:1px solid #2b3750;font-size:12px}
  .pill-ok{border-color:#064e3b;color:#bbf7d0;background:#052e1a}
  .pill-bad{border-color:#7f1d1d;color:#fecaca;background:#3b0a0a}
  .right{margin-left:auto}
  .muted{color:#9aa8bf}
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin — Assinantes</h1>

  <div class="bar">
    <span>Chave Admin:</span>
    <input id="adminKey" placeholder="admin-key" style="min-width:260px">
    <button id="btnSaveKey">Usar chave</button>
    <span id="keyStatus" class="muted">—</span>
    <button id="btnReload" class="right">Recarregar lista</button>
  </div>

  <div class="bar">
    <div class="row" style="flex:1 1 auto">
      <input id="email" placeholder="email" style="min-width:220px">
      <select id="plano">
        <option>mensal</option><option>anual</option><option>trial</option><option>premium</option>
      </select>
      <input id="expira" placeholder="expira_em YYYY-MM-DD" style="min-width:160px">
      <select id="ativo"><option value="TRUE">ativo</option><option value="FALSE">inativo</option></select>
      <select id="role"><option value="user">user</option><option value="admin">admin</option></select>
    </div>
    <button id="btnCreate">Criar</button>
    <button id="btnUpdate">Atualizar</button>
    <button id="btnDelete">Apagar</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Email</th><th>Plano</th><th>Expira</th><th>Ativo</th><th>Role</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="muted" style="margin-top:8px">
    Dica: clique numa linha para carregar no formulário acima.
  </p>
</div>

<script>
/* ===== CONFIG ===== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbzAW06MRS1cAhadH1Zndx0MbB4tm3onKmyeNi8xQXNoURS1Ctn_Zx9HCcsfjQ39LfndWA/exec";
// coloque a mesma ADMIN_KEY do Apps Script para facilitar teste local;
// em produção, prefira digitar manualmente e guardar em sessionStorage.
const DEFAULT_ADMIN_KEY = "";

/* ===== STATE ===== */
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);

function getAdminKey(){
  return sessionStorage.getItem('admin_key') || DEFAULT_ADMIN_KEY || $('#adminKey').value.trim();
}
function setAdminKey(k){
  sessionStorage.setItem('admin_key', k);
  $('#adminKey').value = k;
  $('#keyStatus').textContent = k ? 'chave carregada' : '—';
}

/* ===== API helpers ===== */
async function postForm(data){
  const res = await fetch(ENDPOINT, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
    body: new URLSearchParams(data).toString()
  });
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}

/* ===== CRUD ===== */
async function loadList(){
  const admin_key = getAdminKey();
  if(!admin_key){ alert('Informe a chave admin'); return; }
  const r = await postForm({ action:'admin_list', admin_key });
  if(!r.ok){ alert('Falha: '+(r.reason||'erro')); return; }
  const tb = $('#tbl tbody'); tb.innerHTML='';
  r.items.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.email}</td>
      <td>${it.plano}</td>
      <td>${it.expira_em||''}</td>
      <td>${it.ativo?'<span class="pill pill-ok">ativo</span>':'<span class="pill pill-bad">inativo</span>'}</td>
      <td>${it.role||'user'}</td>`;
    tr.onclick = ()=>{
      $('#email').value = it.email;
      $('#plano').value = it.plano||'mensal';
      $('#expira').value = it.expira_em||'';
      $('#ativo').value = it.ativo?'TRUE':'FALSE';
      $('#role').value  = it.role||'user';
    };
    tb.appendChild(tr);
  });
}

async function createUser(){
  const admin_key = getAdminKey();
  const email = $('#email').value.trim().toLowerCase();
  if(!email) return alert('Informe o e-mail');
  const r = await postForm({
    action:'admin_create', admin_key,
    email, plano:$('#plano').value, expira_em:$('#expira').value,
    ativo:$('#ativo').value, role:$('#role').value
  });
  if(!r.ok) return alert('Falha: '+(r.reason||'erro'));
  await loadList();
}

async function updateUser(){
  const admin_key = getAdminKey();
  const email = $('#email').value.trim().toLowerCase();
  if(!email) return alert('Informe o e-mail');
  const r = await postForm({
    action:'admin_update', admin_key,
    email, plano:$('#plano').value, expira_em:$('#expira').value,
    ativo:$('#ativo').value, role:$('#role').value
  });
  if(!r.ok) return alert('Falha: '+(r.reason||'erro'));
  await loadList();
}

async function deleteUser(){
  const admin_key = getAdminKey();
  const email = $('#email').value.trim().toLowerCase();
  if(!email) return alert('Informe o e-mail');
  if(!confirm('Apagar '+email+'?')) return;
  const r = await postForm({ action:'admin_delete', admin_key, email });
  if(!r.ok) return alert('Falha: '+(r.reason||'erro'));
  $('#email').value=''; $('#expira').value='';
  await loadList();
}

/* ===== UI hooks ===== */
$('#btnSaveKey').onclick = ()=> setAdminKey($('#adminKey').value.trim());
$('#btnReload').onclick  = loadList;
$('#btnCreate').onclick  = createUser;
$('#btnUpdate').onclick  = updateUser;
$('#btnDelete').onclick  = deleteUser;

/* ===== Start ===== */
(() => {
  setAdminKey(getAdminKey()); // carrega/default
  loadList();
})();
</script>
</body>
</html>
