<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Painel Cripto PRO — 2 Gráficos + ST/MKR + IA + Contas (RBAC)</title>

<!-- ================== Estilos ================== -->
<style>
  :root{
    --bg:#0b1220;--panel:#0e1627;--soft:#111b2f;--muted:#334155;--text:#e5e7eb;
    --ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--line:#22304a;--info:#60a5fa
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{padding:16px;max-width:1680px;margin:auto}
  h1{margin:0 0 10px 0;font-size:18px;font-weight:700}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .topbar{background:var(--panel);border:1px solid #1f2a40;border-radius:12px;padding:10px}
  .chip{background:var(--soft);border:1px solid #243149;border-radius:10px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center;font-size:14px}
  .muted{color:#9aa8bf}
  select,input,button{background:#0b1220;color:var(--text);border:1px solid #2c3a52;border-radius:10px;padding:6px 10px}
  input{min-width:220px}
  button{cursor:pointer} button:hover{filter:brightness(1.12)}
  .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr;margin-top:12px}
  .card{background:var(--panel);border:1px solid #1f2a40;border-radius:12px;padding:12px;min-height:460px}
  .headRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .title{font-weight:700}
  .title .sub{font-weight:500;font-size:12px;color:#9aa8bf;margin-left:6px}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid #2b3750;font-size:12px;background:#0b1220}
  .b-green{border-color:#064e3b;color:#bbf7d0;background:#052e1a}
  .b-red{border-color:#7f1d1d;color:#fecaca;background:#3b0a0a}
  .b-yellow{border-color:#854d0e;color:#fde68a;background:#3a2a06}
  .b-blue{border-color:#1d4ed8;color:#dbeafe;background:#0b1e43}
  .chart{height:540px}
  .trendRow{display:flex;gap:8px;flex-wrap:wrap}
  .split{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  footer{margin-top:12px;color:#9aa8bf;font-size:12px;text-align:center}

  /* Modais */
  .mask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .modal{width:860px;max-width:92vw;background:var(--panel);border:1px solid #1f2a40;border-radius:14px;padding:16px}
  .modal h3{margin:0 0 10px 0}
  .vstack{display:flex;flex-direction:column;gap:8px}
  .hint{font-size:12px;color:#9aa8bf}
  .toast{position:fixed;left:16px;bottom:16px;background:#3a2a06;color:#fde68a;border:1px solid #854d0e;padding:8px 12px;border-radius:10px;display:none;z-index:25}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border:1px solid #1f2a40;padding:6px 8px;text-align:left}
  th{background:#0b1425}
  #tblUsers td select, #tblUsers td input[type="checkbox"]{ background:#0b1220; color:var(--text); border:1px solid #2c3a52; border-radius:8px; padding:3px 6px }
  .disabled{opacity:.6; pointer-events:none}
</style>

<!-- ================== Charts ================== -->
<script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>

<!-- ================== Firebase compat (ordem importa) ================== -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<!-- ================== Firebase init ================== -->
<script>
  // Config do seu projeto Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAN70DLpn18XA11_JwjtkodpaOjquKEs3U",
    authDomain: "painel-cripto-pro.firebaseapp.com",
    projectId: "painel-cripto-pro",
    storageBucket: "painel-cripto-pro.firebasestorage.app",
    messagingSenderId: "897004329063",
    appId: "1:897004329063:web:b486598ff0f42fb52e5cc2",
    measurementId: "G-82VVH8YF7Y"
  };
  const _app = firebase.initializeApp(firebaseConfig);
  const _auth = firebase.auth();
  const _db   = firebase.firestore();
  window._fb  = { app:_app, auth:_auth, db:_db };

  // Helper para garantir que o Firebase está pronto antes de usar
  function waitForFirebase(){
    return new Promise((resolve,reject)=>{
      let tries=0;
      (function check(){
        if(window._fb && window._fb.auth && window._fb.db) return resolve(window._fb);
        if(++tries>200) return reject(new Error('Firebase não inicializou'));
        setTimeout(check,25);
      })();
    });
  }
</script>
</head>

<body>
<div class="wrap">
  <h1>Painel Cripto PRO — 2 Gráficos + Tendência (ST/MKR) + IA + Contas (Permissões)</h1>

  <!-- Topo -->
  <div class="topbar">
    <div class="split">
      <div class="row">
        <span class="muted">Cotações:</span>
        <span class="chip">BTC/BRL: <b id="q_btcbrl">—</b></span>
        <span class="chip">BTC/USDT: <b id="q_btcusdt">—</b></span>
        <span class="chip">USD/BRL: <b id="q_usdbrl">—</b></span>
        <span class="muted" id="lastTs">—</span>
      </div>
      <div class="row">
        <label class="chip">Auto:
          <select id="autoSel">
            <option value="0">Off</option>
            <option value="2000">2s</option>
            <option value="5000" selected>5s</option>
            <option value="10000">10s</option>
            <option value="15000">15s</option>
          </select>
        </label>
        <label class="chip">Fuso
          <select id="tzSel">
            <option value="America/Sao_Paulo" selected>America/Sao_Paulo (BR)</option>
            <option value="UTC">UTC</option>
            <option value="America/Bogota">America/Bogota</option>
            <option value="America/Lima">America/Lima</option>
            <option value="America/Argentina/Buenos_Aires">America/Argentina/Buenos_Aires</option>
            <option value="America/Santiago">America/Santiago</option>
            <option value="America/Mexico_City">America/Mexico_City</option>
            <option value="America/Toronto">America/Toronto</option>
            <option value="America/New_York">America/New_York</option>
            <option value="America/Los_Angeles">America/Los_Angeles</option>
            <option value="Europe/Lisbon">Europe/Lisbon</option>
            <option value="Europe/London">Europe/London</option>
            <option value="Europe/Madrid">Europe/Madrid</option>
            <option value="Europe/Paris">Europe/Paris</option>
            <option value="Europe/Rome">Europe/Rome</option>
            <option value="Europe/Zurich">Europe/Zurich</option>
            <option value="Europe/Amsterdam">Europe/Amsterdam</option>
            <option value="Europe/Berlin">Europe/Berlin</option>
            <option value="Europe/Moscow">Europe/Moscow</option>
            <option value="Africa/Johannesburg">Africa/Johannesburg</option>
            <option value="Asia/Dubai">Asia/Dubai</option>
            <option value="Asia/Kolkata">Asia/Kolkata</option>
            <option value="Asia/Singapore">Asia/Singapore</option>
            <option value="Asia/Hong_Kong">Asia/Hong_Kong</option>
            <option value="Asia/Shanghai">Asia/Shanghai</option>
            <option value="Asia/Seoul">Asia/Seoul</option>
            <option value="Asia/Tokyo">Asia/Tokyo</option>
            <option value="Australia/Sydney">Australia/Sydney</option>
            <option value="Pacific/Auckland">Pacific/Auckland</option>
          </select>
        </label>
        <label class="chip">IA Webhook
          <input id="iaUrl" placeholder="https://seu-endpoint-ia/exec">
        </label>
        <label class="chip">Chave
          <input id="iaKey" placeholder="Bearer xxxxx (opcional)">
        </label>
        <label class="chip"><input type="checkbox" id="iaAuto" checked> IA em cada refresh</label>
        <button id="btnIaTest">Testar IA</button>

        <span class="chip">Sessão: <b id="sessStatus" class="muted">desconectado</b></span>
        <button id="btnOpenLogin">Entrar</button>
        <button id="btnLogout" style="display:none">Sair</button>
        <button id="btnAdmin" style="display:none">Admin</button>
      </div>
    </div>
  </div>

  <!-- Grids -->
  <div class="grid">
    <!-- L -->
    <div class="card">
      <div class="headRow">
        <div class="row"><span id="pairTitleL" class="title">—</span></div>
        <div class="row">
          <label class="chip">Moeda
            <select id="coinL">
              <option selected>BTC</option>
              <option>ETH</option>
              <option>SOL</option>
              <option>BNB</option>
              <option>XRP</option>
              <option>ADA</option>
              <option>DOGE</option>
              <option>TON</option>
              <option>DOT</option>
              <option>USDC</option>
              <option>MATIC</option>
              <option>AVAX</option>
              <option>LTC</option>
              <option>TRX</option>
              <option>SHIB</option>
            </select>
          </label>
          <label class="chip">Contra
            <select id="quoteL"><option>BRL</option><option selected>USDT</option></select>
          </label>
          <label class="chip">TF
            <select id="tfL">
              <option>1M</option><option selected>3M</option><option>5M</option><option>15M</option>
              <option>30M</option><option>1H</option><option>1D</option><option>1MO</option>
            </select>
          </label>
          <label class="chip">Velas
            <select id="lenL"><option>120</option><option selected>360</option><option>720</option><option>1200</option></select>
          </label>
        </div>
      </div>
      <div id="chartL" class="chart"></div>
      <div class="row" style="margin-top:10px">
        <div class="trendRow">
          <span class="badge b-yellow" id="tendL">Tendência: —</span>
          <span class="badge b-blue"   id="recL">Recomendação: —</span>
          <span class="badge" id="stBadgeL">ST: —</span>
          <span class="badge" id="mkrBadgeL">MKR: —</span>
          <span class="badge" id="atrBadgeL">ATR: —</span>
          <span class="badge" id="pctBadgeL">24h: —</span>
          <span class="badge" id="iaBadgeL">IA: —</span>
        </div>
      </div>
    </div>

    <!-- R -->
    <div class="card">
      <div class="headRow">
        <div class="row"><span id="pairTitleR" class="title">—</span></div>
        <div class="row">
          <label class="chip">Moeda
            <select id="coinR">
              <option selected>BTC</option>
              <option>ETH</option>
              <option>SOL</option>
              <option>BNB</option>
              <option>XRP</option>
              <option>ADA</option>
              <option>DOGE</option>
              <option>TON</option>
              <option>DOT</option>
              <option>USDC</option>
              <option>MATIC</option>
              <option>AVAX</option>
              <option>LTC</option>
              <option>TRX</option>
              <option>SHIB</option>
            </select>
          </label>
          <label class="chip">Contra
            <select id="quoteR"><option>BRL</option><option selected>USDT</option></select>
          </label>
          <label class="chip">TF
            <select id="tfR">
              <option>1M</option><option selected>3M</option><option>5M</option><option>15M</option>
              <option>30M</option><option>1H</option><option>1D</option><option>1MO</option>
            </select>
          </label>
          <label class="chip">Velas
            <select id="lenR"><option>120</option><option selected>360</option><option>720</option><option>1200</option></select>
          </label>
        </div>
      </div>
      <div id="chartR" class="chart"></div>
      <div class="row" style="margin-top:10px">
        <div class="trendRow">
          <span class="badge b-yellow" id="tendR">Tendência: —</span>
          <span class="badge b-blue"   id="recR">Recomendação: —</span>
          <span class="badge" id="stBadgeR">ST: —</span>
          <span class="badge" id="mkrBadgeR">MKR: —</span>
          <span class="badge" id="atrBadgeR">ATR: —</span>
          <span class="badge" id="pctBadgeR">24h: —</span>
          <span class="badge" id="iaBadgeR">IA: —</span>
        </div>
      </div>
    </div>
  </div>

  <footer>Painel Cripto Pro © 2025 — Desenvolvido por Marcelo. Para toda Honra e Glória do Senhor Jesus!</footer>
</div>

<!-- ===== Modal Login ===== -->
<div class="mask" id="loginMask">
  <div class="modal">
    <h3>Entrar</h3>
    <div class="vstack">
      <input id="inEmail" placeholder="seu@email.com"/>
      <input id="inPass"  placeholder="senha" type="password"/>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="btnCancelLogin">Cancelar</button>
      <button id="btnDoLogin">Entrar</button>
    </div>
    <p class="hint">Se não existir, a conta será criada automaticamente.</p>
  </div>
</div>

<!-- ===== Modal Admin (convites & usuários) ===== -->
<div class="mask" id="adminMask">
  <div class="modal">
    <h3>Admin — Convites & Usuários</h3>

    <!-- Tabs -->
    <div class="row" style="margin:8px 0">
      <button id="tabInvites" class="chip" style="cursor:pointer">Convites</button>
      <button id="tabUsers" class="chip" style="cursor:pointer">Usuários</button>
    </div>

    <!-- Pane Convites -->
    <div id="invitesPane">
      <div class="vstack" style="margin-bottom:8px">
        <div class="row" style="flex-wrap:wrap">
          <input id="invEmail" placeholder="email do usuário">
          <select id="invRole">
            <option value="user" selected>user</option>
            <option value="admin">admin</option>
          </select>
          <button id="btnAddInvite">Adicionar convite</button>
        </div>
        <p class="hint">Usuários convidados: ao fazer login, recebem o papel do convite (se ainda não tiverem um perfil).</p>
      </div>
      <table id="tblInvites">
        <thead><tr><th>Email</th><th>Papel</th><th>Ações</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Pane Usuários -->
    <div id="usersPane" style="display:none">
      <table id="tblUsers">
        <thead>
          <tr>
            <th>Email</th>
            <th>Papel</th>
            <th>IA</th>
            <th>TZ</th>
            <th>Pares/TF</th>
            <th>Auto</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="btnCloseAdmin">Fechar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ================== App Script ================== -->
<script>
/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const fmtNum = (n,d=2)=>Number.isFinite(n)?n.toLocaleString('pt-BR',{minimumFractionDigits:d,maximumFractionDigits:d}):'—';
function toast(msg,ms=2500){const t=$('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',ms);} 

/* ===== Timezone helpers (aplicado também no eixo do gráfico) ===== */
let currentTZ = 'America/Sao_Paulo';
function makeTimeFormatters(tz){
  const fmtTime = new Intl.DateTimeFormat('pt-BR',{hour:'2-digit',minute:'2-digit',timeZone:tz});
  const fmtDay  = new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'2-digit',timeZone:tz});
  const fmtFull = new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',timeZone:tz});
  const timeFormatter = (time)=>{ const ts=(time&&time.timestamp)||time; return fmtFull.format(new Date(ts*1000)); };
  const tickMarkFormatter = (time, tickType)=>{ const ts=(time&&time.timestamp)||time; return tickType<=1? fmtDay.format(new Date(ts*1000)) : fmtTime.format(new Date(ts*1000)); };
  return { timeFormatter, tickMarkFormatter };
}
function updateLastTs(){ $('lastTs').textContent='Atualizado: '+ new Intl.DateTimeFormat('pt-BR',{dateStyle:'short',timeStyle:'medium',timeZone:currentTZ}).format(new Date()); }

/* ===== Binance + Indicadores ===== */
const tfMap={ '1M':'1m','3M':'3m','5M':'5m','15M':'15m','30M':'30m','1H':'1h','1D':'1d','1MO':'1M' };
const symbolOf=(c,q)=>(c+q).toUpperCase();

async function fetchTopQuotes(){
  try{
    const [pU,pB,usdt]=await Promise.all([
      fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT').then(r=>r.json()),
      fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCBRL').then(r=>r.json()),
      fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTBRL').then(r=>r.json()).catch(()=>({price:null}))
    ]);
    $('q_btcusdt').textContent=fmtNum(+pU.price,2)+' USDT';
    $('q_btcbrl').textContent=(+pB.price).toLocaleString('pt-BR');
    $('q_usdbrl').textContent=Number.isFinite(+usdt.price)?fmtNum(+usdt.price,2):'—';
    updateLastTs();
  }catch{ $('lastTs').textContent='Atualizado: erro'; }
}
async function fetchKlines(symbol, interval, limit=360){
  const url=`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const arr=await fetch(url).then(r=>r.json());
  if(!Array.isArray(arr)||!arr.length) return [];
  return arr.map(k=>({time:Math.floor(k[0]/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4]}));
}
async function dayStats(symbol){
  try{const j=await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`).then(r=>r.json());
       const pct=j&&j.priceChangePercent!=null?+j.priceChangePercent:null; return {pct};}
  catch{return{pct:null}}
}
function rma(vals,len){const out=[];let p=null,a=1/len;for(let i=0;i<vals.length;i++){const v=vals[i];p=(p==null)?v:(p+a*(v-p));out.push(p)}return out}
function trueRange(h,l,cPrev){return Math.max(h-l,Math.abs(h-cPrev),Math.abs(l-cPrev))}
function calcSuperTrend(ohlc,len=10,mul=3){
  const n=ohlc.length;if(!n) return {dir:0,atr:0,line:[]};
  const tr=[];for(let i=0;i<n;i++){const cp=i>0?ohlc[i-1].close:ohlc[i].close;tr.push(trueRange(ohlc[i].high,ohlc[i].low,cp))}
  const atr=rma(tr,len);const st=new Array(n).fill(null),dir=new Array(n).fill(0);
  for(let i=0;i<n;i++){const o=ohlc[i],mid=(o.high+o.low)/2,ub=mid+mul*atr[i],lb=mid-mul*atr[i];
    if(i===0){st[i]=ub;dir[i]=-1;continue}
    const prevSt=st[i-1],prevDir=dir[i-1];
    if(prevDir===-1){const newUb=Math.min(ub,prevSt);st[i]=(o.close>newUb)?lb:newUb;dir[i]=(o.close>newUb)?+1:-1}
    else{const newLb=Math.max(lb,prevSt);st[i]=(o.close<newLb)?ub:newLb;dir[i]=(o.close<newLb)?-1:+1}
  }
  return {dir:dir[n-1],atr:atr[n-1],line:st}
}
function K(kernel,x,bw){const u=x/bw;return Math.exp(-0.5*u*u)/Math.sqrt(2*Math.PI)}
function mkrSmooth(arr,bw=14,dev=2){
  const n=arr.length;const mean=new Array(n),up=new Array(n),dn=new Array(n);
  for(let i=0;i<n;i++){let wsum=0,vsum=0,vsq=0;const left=Math.max(0,i-bw+1);
    for(let j=left;j<=i;j++){const w=K('Gaussian',i-j,bw/3);wsum+=w;vsum+=arr[j]*w;vsq+=arr[j]*arr[j]*w}
    const mu=vsum/wsum;const sd=Math.sqrt(Math.max(0,(vsq/wsum)-mu*mu));mean[i]=mu;up[i]=mu+dev*sd;dn[i]=mu-dev*sd}
  const slope=(n>1&&Number.isFinite(mean[n-1])&&Number.isFinite(mean[n-2]))?(mean[n-1]-mean[n-2]):0;
  return {mean,up,dn,slope,delta:slope}
}

/* ===== Charts ===== */
function mkChart(id){
  const el=$(id);
  const { timeFormatter, tickMarkFormatter } = makeTimeFormatters(currentTZ);
  const chart=LightweightCharts.createChart(el,{layout:{background:{color:'#0e1627'},textColor:'#cbd5e1'},
    grid:{vertLines:{color:'#1f2a40'},horzLines:{color:'#1f2a40'}},rightPriceScale:{borderColor:'#1f2a40'},
    timeScale:{borderColor:'#1f2a40',timeVisible:true,secondsVisible:false,tickMarkFormatter},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
    handleScroll:{mouseWheel:true,pressedMouseMove:true},handleScale:{axisPressedMouseMove:true,mouseWheel:true,pinch:true},
    localization:{locale:'pt-BR', timeFormatter}});
  const candle=chart.addCandlestickSeries({upColor:'#16a34a',downColor:'#ef4444',borderVisible:false,wickUpColor:'#16a34a',wickDownColor:'#ef4444'});
  chart.timeScale().applyOptions({rightOffset:5,barSpacing:3});
  new ResizeObserver(()=>{const r=el.getBoundingClientRect();chart.resize(Math.floor(r.width),Math.floor(r.height))}).observe(el);
  return {chart,candle}
}
function reapplyTimezone(chart){
  const { timeFormatter, tickMarkFormatter } = makeTimeFormatters(currentTZ);
  chart.applyOptions({ localization:{locale:'pt-BR', timeFormatter}, timeScale:{ tickMarkFormatter } });
}
const L=mkChart('chartL'), R=mkChart('chartR');
reapplyTimezone(L.chart); reapplyTimezone(R.chart);

function setDataPreserveView(series,chart,data){
  const ts=chart.timeScale(), atRight=Math.abs(ts.scrollPosition())<1e-2, vr=ts.getVisibleLogicalRange();
  series.setData(data); if(!atRight && vr){ ts.setVisibleLogicalRange(vr) } else { ts.scrollToRealTime() }
}
function pctClass(p){return p>0?'b-green':(p<0?'b-red':'b-yellow')}
function setBadge(el,text,cls){el.className='badge '+cls;el.textContent=text}
async function updatePairHeader(side,symbol,tf){
  const el=side==='L'?$('pairTitleL'):$('pairTitleR');
  try{
    const [px,day]=await Promise.all([
      fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`).then(r=>r.json()), dayStats(symbol)
    ]);
    const price=+px.price, pct=day.pct, pctTxt=(pct==null?'—':(pct>0?`+${pct.toFixed(2)}`:pct.toFixed(2))+'%'),
          pCls=pctClass(pct), quote=symbol.endsWith('USDT')?'USDT':'BRL',
          pairLabel=`${symbol.slice(0,-(quote==='USDT'?4:3))}/${quote}`;
    el.innerHTML=`${pairLabel} <span class="sub">(${tf})</span>
      <span class="badge">${quote==='USDT'?fmtNum(price,2)+' USDT':price.toLocaleString('pt-BR')+' BRL'}</span>
      <span class="badge ${pCls}" style="margin-left:6px">${pctTxt}</span>`;
    (side==='L'?$('pctBadgeL'):$('pctBadgeR')).className='badge '+pCls;
    (side==='L'?$('pctBadgeL'):$('pctBadgeR')).textContent='24h: '+pctTxt;
  }catch{ el.textContent=symbol+` (${tf})` }
}
function decideLocalAndBadges(side,data){
  if(!data.length){
    const ids=side==='L'?[ 'tendL','recL','stBadgeL','mkrBadgeL','atrBadgeL']:[ 'tendR','recR','stBadgeR','mkrBadgeR','atrBadgeR'];
    ids.forEach(id=>setBadge($(id),'—','')); (side==='L'?$('iaBadgeL'):$('iaBadgeR')).textContent='IA: —';
    return {tend:'Mista',rec:'Aguardar'}
  }
  const st=calcSuperTrend(data,10,3), closes=data.map(d=>d.close), mkr=mkrSmooth(closes,14,2);
  const dirST=st.dir, atr=st.atr, slope=mkr.slope;
  const stText=dirST>0?'ST: Alta':(dirST<0?'ST: Baixa':'ST: Neutra'), stCls=dirST>0?'b-green':(dirST<0?'b-red':'b-yellow');
  const mkrText=(slope>0?'MKR: ↑':(slope<0?'MKR: ↓':'MKR: →'))+`  Δ${fmtNum(mkr.delta,2)}`, mkrCls=slope>0?'b-green':(slope<0?'b-red':'b-yellow');
  const sameBear=(dirST<0&&slope<0), sameBull=(dirST>0&&slope>0);
  const tendencia=sameBull?'Alta':(sameBear?'Baixa':'Mista'), tendCls=sameBull?'b-green':(sameBear?'b-red':'b-yellow');
  let rec='Aguardar', recCls='b-blue'; if(sameBull){rec='Comprar (confluência)';recCls='b-green'} else if(sameBear){rec='Vender / reduzir';recCls='b-red'}
  if(side==='L'){ setBadge($('tendL'),`Tendência: ${tendencia}`,tendCls); setBadge($('recL'),`Recomendação: ${rec}`,recCls);
    setBadge($('stBadgeL'),stText,stCls); setBadge($('mkrBadgeL'),mkrText,mkrCls); setBadge($('atrBadgeL'),`ATR: ${fmtNum(atr,2)}`,'b-blue')}
  else { setBadge($('tendR'),`Tendência: ${tendencia}`,tendCls); setBadge($('recR'),`Recomendação: ${rec}`,recCls);
    setBadge($('stBadgeR'),stText,stCls); setBadge($('mkrBadgeR'),mkrText,mkrCls); setBadge($('atrBadgeR'),`ATR: ${fmtNum(atr,2)}`,'b-blue')}
  return {tend:tendencia,rec}
}

/* ===== IA (JSON puro via POST) ===== */
function getIaConfig(){ return { url: $('iaUrl').value.trim(), key: $('iaKey').value.trim() } }
async function callIaWebhook(payload){
  const { url, key } = getIaConfig(); if(!url) throw new Error('IA URL vazia');
  const headers={'Content-Type':'application/json'}; if(key) headers['Authorization']=key;
  const r = await fetch(url,{method:'POST',headers,body:JSON.stringify(payload)});
  let j = null; try{ j = await r.json(); }catch(_){}
  if(!r.ok) throw new Error(j?.error || ('HTTP '+r.status));
  if(!(j && (j.ok===true || j.advice))) throw new Error('Resposta inválida');
  return j;
}
async function testIa(){
  const { url, key } = getIaConfig(); if(!url) throw new Error('Configure a URL da IA');
  const headers={'Content-Type':'application/json'}; if(key) headers['Authorization']=key;
  const r = await fetch(url,{method:'POST',headers,body:JSON.stringify({ping:true,now:Date.now()})});
  let j=null; try{ j=await r.json(); }catch(_){ }
  if(!r.ok) throw new Error(j?.error||('HTTP '+r.status));
  return j?.message||j?.advice||'sucesso';
}

/* ===== Auth + Perfis (Firestore) ===== */
let auth, db, userDocUnsub=null, invitesUnsub=null, usersUnsub=null, isAdmin=false;

// Semente (emails que SEMPRE são admin)
const ADMIN_EMAILS = [ 'mjcsvieira@gmail.com' ];

let currentPerm = { canIA:false, canChangeTZ:false, canChangePairs:false, canChangeAuto:false };

function setSessionUI(user){
  if(user){ $('sessStatus').textContent=user.email; $('btnOpenLogin').style.display='none'; $('btnLogout').style.display=''; }
  else{ $('sessStatus').textContent='desconectado'; $('btnOpenLogin').style.display=''; $('btnLogout').style.display='none'; $('btnAdmin').style.display='none'; isAdmin=false; }
}
function applyPermissions(){
  const isDisabled = (flag)=> (!isAdmin && !currentPerm[flag]);
  // IA controls
  $('iaUrl').disabled = isDisabled('canIA');
  $('iaKey').disabled = isDisabled('canIA');
  $('iaAuto').disabled= isDisabled('canIA');
  $('btnIaTest').classList.toggle('disabled', isDisabled('canIA'));
  // Timezone
  $('tzSel').disabled = isDisabled('canChangeTZ');
  // Pairs / TF / Len
  ['coinL','quoteL','tfL','lenL','coinR','quoteR','tfR','lenR'].forEach(id=>{ const el=$(id); if(el) el.disabled = isDisabled('canChangePairs'); });
  // Auto refresh
  $('autoSel').disabled = isDisabled('canChangeAuto');
}
async function loadUserProfile(uid){
  const s = await db.collection('users').doc(uid).get();
  const d = s.exists ? s.data() : {};
  const p = d.profile || {};
  const perm = d.permissions || {};
  currentTZ = p.tz || 'America/Sao_Paulo'; $('tzSel').value=currentTZ; reapplyTimezone(L.chart); reapplyTimezone(R.chart); updateLastTs();
  currentPerm = { canIA:!!perm.canIA, canChangeTZ:!!perm.canChangeTZ, canChangePairs:!!perm.canChangePairs, canChangeAuto:!!perm.canChangeAuto };
  applyPermissions();
}
async function saveUserProfile(uid, partial){ await db.collection('users').doc(uid).set({ profile: partial }, { merge: true }); }

$('tzSel').onchange = async ()=>{
  if($('tzSel').disabled){ $('tzSel').value=currentTZ; return; }
  currentTZ = $('tzSel').value; reapplyTimezone(L.chart); reapplyTimezone(R.chart); updateLastTs();
  const u = auth?.currentUser; if(u){ await saveUserProfile(u.uid,{ tz: currentTZ }); }
};

/* Login handlers */
$('btnOpenLogin').onclick = ()=>{ $('loginMask').style.display='flex'; $('inEmail').focus(); };
$('btnCancelLogin').onclick = ()=>{ $('loginMask').style.display='none'; };
$('btnLogout').onclick = async ()=>{ try{ await auth.signOut(); toast('Sessão encerrada'); }catch(e){ toast('Erro ao sair'); } };
$('btnDoLogin').onclick = async ()=>{
  const email = $('inEmail').value.trim(), pass = $('inPass').value;
  if(!email || !pass){ toast('Informe e-mail e senha'); return; }
  try{
    await auth.signInWithEmailAndPassword(email,pass).catch(async err=>{
      if(err.code==='auth/user-not-found'){
        await auth.createUserWithEmailAndPassword(email,pass);
        toast('Conta criada');
      } else { throw err; }
    });
    $('loginMask').style.display='none';
  }catch(e){ toast('Falha login: '+(e.message||e)); }
};

/* Admin modal */
const adminMask=$('adminMask'), tblBody=$('tblInvites').querySelector('tbody');
$('btnAdmin').onclick=()=>{ adminMask.style.display='flex' }
$('btnCloseAdmin').onclick=()=>{ adminMask.style.display='none' }
$('btnAddInvite').onclick=async()=>{
  try{
    const email=$('invEmail').value.trim().toLowerCase(), role=$('invRole').value;
    if(!email) return toast('Email vazio');
    await db.collection('invites').doc(email).set({role,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    $('invEmail').value=''; toast('Convite adicionado');
    // aplica direto se o usuário já existe
    try{ const q=await db.collection('users').where('email','==',email).limit(1).get(); if(!q.empty){ const uid=q.docs[0].id; await db.collection('users').doc(uid).set({ role },{merge:true}); toast('Convite aplicado ao usuário existente'); }}catch(_){}
  }catch(e){ toast('Erro ao adicionar: '+e.message) }
};
function renderInvitesSnapshot(snap){
  tblBody.innerHTML='';
  snap.forEach(doc=>{ const {role}=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${role}</td><td><button data-id=\"${doc.id}\" class=\"rm\">Remover</button></td>`; tblBody.appendChild(tr); });
  tblBody.querySelectorAll('button.rm').forEach(btn=>{ btn.onclick=async()=>{ try{ await db.collection('invites').doc(btn.dataset.id).delete(); toast('Convite removido') }catch(e){ toast('Erro: '+e.message)} } });
}

/* Bootstrap de usuário: perfil + permissões default bloqueadas */
async function bootstrapUser(user){
  const uid = user.uid, email = (user.email||'').toLowerCase();
  const ref = db.collection('users').doc(uid);
  const doc = await ref.get();
  if(!doc.exists){
    // Papel padrão
    let role = 'user';
    // 1) Se for e-mail semente, já vira admin
    if (ADMIN_EMAILS.includes(email)) role = 'admin';
    // 2) Se houver convite para este e-mail, aplica o papel do convite e consome-o
    try{
      const inv = await db.collection('invites').doc(email).get();
      if(inv.exists){ role = inv.data().role || role; await inv.ref.delete(); }
    }catch(_){ /* ignore */ }
    await ref.set({
      email,
      role,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      profile: { tz: 'America/Sao_Paulo' },
      permissions: { canIA:false, canChangeTZ:false, canChangePairs:false, canChangeAuto:false }
    });
  }
}

/* Aba Usuários */
const usersPane = $('usersPane'), invitesPane = $('invitesPane');
$('tabInvites').onclick = ()=>{ invitesPane.style.display=''; usersPane.style.display='none'; };
$('tabUsers').onclick   = ()=>{ invitesPane.style.display='none'; usersPane.style.display=''; };
const usersTBody = $('tblUsers').querySelector('tbody');
function renderUsersSnapshot(snap){
  usersTBody.innerHTML='';
  snap.forEach(doc=>{
    const d = doc.data()||{}; const email=d.email||'(sem email)'; const role=d.role||'user'; const perm=d.permissions||{};
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${email}</td>
      <td><select data-uid=\"${doc.id}\" class=\"roleSel\"><option value=\"user\" ${role==='user'?'selected':''}>user</option><option value=\"admin\" ${role==='admin'?'selected':''}>admin</option></select></td>
      <td style=\"text-align:center\"><input type=\"checkbox\" class=\"p-ia\" data-uid=\"${doc.id}\" ${perm.canIA?'checked':''}></td>
      <td style=\"text-align:center\"><input type=\"checkbox\" class=\"p-tz\" data-uid=\"${doc.id}\" ${perm.canChangeTZ?'checked':''}></td>
      <td style=\"text-align:center\"><input type=\"checkbox\" class=\"p-pairs\" data-uid=\"${doc.id}\" ${perm.canChangePairs?'checked':''}></td>
      <td style=\"text-align:center\"><input type=\"checkbox\" class=\"p-auto\" data-uid=\"${doc.id}\" ${perm.canChangeAuto?'checked':''}></td>
      <td><button class=\"btnApply\" data-uid=\"${doc.id}\">Aplicar</button></td>`;
    usersTBody.appendChild(tr);
  });
  usersTBody.querySelectorAll('.btnApply').forEach(btn=>{
    btn.onclick=async()=>{
      try{
        const uid=btn.dataset.uid; const role=usersTBody.querySelector(`select.roleSel[data-uid=\"${uid}\"]`).value;
        const canIA=usersTBody.querySelector(`input.p-ia[data-uid=\"${uid}\"]`).checked;
        const canChangeTZ=usersTBody.querySelector(`input.p-tz[data-uid=\"${uid}\"]`).checked;
        const canChangePairs=usersTBody.querySelector(`input.p-pairs[data-uid=\"${uid}\"]`).checked;
        const canChangeAuto=usersTBody.querySelector(`input.p-auto[data-uid=\"${uid}\"]`).checked;
        await db.collection('users').doc(uid).set({ role, permissions:{ canIA, canChangeTZ, canChangePairs, canChangeAuto } },{merge:true});
        toast('Permissões atualizadas');
      }catch(e){ toast('Erro: '+e.message); }
    };
  });
}

async function startAuth(){
  await waitForFirebase(); auth=window._fb.auth; db=window._fb.db;
  auth.onAuthStateChanged(async (user)=>{
    setSessionUI(user);
    if(user){
      await bootstrapUser(user);
      await loadUserProfile(user.uid);
      userDocUnsub && userDocUnsub(); invitesUnsub && invitesUnsub(); usersUnsub && usersUnsub();
      userDocUnsub = db.collection('users').doc(user.uid).onSnapshot(s=>{
        const storedRole = s.exists ? (s.data().role||'user') : 'user';
        const seeded = ADMIN_EMAILS.includes((user.email||'').toLowerCase());
        // Garante admin no perfil se for e-mail semente
        if(seeded && storedRole!=='admin'){
          db.collection('users').doc(user.uid).set({ role:'admin' }, { merge:true }).catch(()=>{});
        }
        isAdmin = seeded || storedRole==='admin';
        $('btnAdmin').style.display = isAdmin ? '' : 'none';
        applyPermissions();
        if(isAdmin){
          invitesUnsub = db.collection('invites').orderBy('createdAt','desc').onSnapshot(renderInvitesSnapshot);
          usersUnsub   = db.collection('users').orderBy('createdAt','desc').onSnapshot(renderUsersSnapshot);
        }else{
          tblBody.innerHTML=''; usersTBody.innerHTML='';
        }
      });
    }else{
      userDocUnsub && userDocUnsub(); userDocUnsub=null;
      invitesUnsub && invitesUnsub(); invitesUnsub=null;
      usersUnsub && usersUnsub(); usersUnsub=null;
      tblBody.innerHTML=''; usersTBody.innerHTML='';
    }
  });
}

/* ===== Controles ===== */
['coinL','quoteL','tfL','lenL'].forEach(id=>$(id).addEventListener('change',()=>{ if($(id).disabled) return; loadSide('L') }));
['coinR','quoteR','tfR','lenR'].forEach(id=>$(id).addEventListener('change',()=>{ if($(id).disabled) return; loadSide('R') }));
$('btnIaTest').onclick=async()=>{ if($('btnIaTest').classList.contains('disabled')) return; try{ const ok=await testIa(); toast('IA OK: '+ok) }catch(e){ toast('Falha IA: '+e.message) } };
$('tzSel').addEventListener('change',()=>{ /* já salvo no handler acima via onChange */ });

async function loadSide(side){
  const coin=(side==='L'?$('coinL').value:$('coinR').value),
        quote=(side==='L'?$('quoteL').value:$('quoteR').value),
        tfLbl=(side==='L'?$('tfL').value:$('tfR').value),
        len=(side==='L'?+$('lenL').value:+$('lenR').value),
        symbol=symbolOf(coin,quote), intv=tfMap[tfLbl];
  const data=await fetchKlines(symbol,intv,len);
  if(side==='L') setDataPreserveView(L.candle,L.chart,data); else setDataPreserveView(R.candle,R.chart,data);
  updatePairHeader(side,symbol,tfLbl); const local=decideLocalAndBadges(side,data);

  if((isAdmin || currentPerm.canIA) && data.length && $('iaAuto').checked && !$('iaAuto').disabled){
    try{
      const res = await callIaWebhook({symbol,tf:tfLbl,ohlc:data.slice(-120),local,tz:currentTZ});
      (side==='L'?$('iaBadgeL'):$('iaBadgeR')).textContent='IA: '+(res?.advice||local.rec);
    }catch(e){ (side==='L'?$('iaBadgeL'):$('iaBadgeR')).textContent='IA: erro'; console.warn('[IA]',e); }
  }else{
    (side==='L'?$('iaBadgeL'):$('iaBadgeR')).textContent='IA: '+local.rec;
  }
}

async function refreshAll(){ await fetchTopQuotes(); await Promise.all([loadSide('L'),loadSide('R')]) }
let timer=null; function setAuto(ms){ if(timer) clearInterval(timer); if(ms>0) timer=setInterval(refreshAll,ms) }
$('autoSel').onchange=()=>{ if($('autoSel').disabled) return; setAuto(+$('autoSel').value) };

/* ===== Start ===== */
(async ()=>{
  await waitForFirebase();
  // presets
  $('coinL').value='BTC';$('quoteL').value='BRL';$('tfL').value='3M';$('lenL').value='360';
  $('coinR').value='BTC';$('quoteR').value='USDT';$('tfR').value='3M';$('lenR').value='360';
  await refreshAll(); setAuto(+$('autoSel').value);
  startAuth();
})();
</script>

<!--
==== Regras Firestore sugeridas (cole no Console, aba Rules) ====

rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function isAdmin() {
      return request.auth != null
        && exists(/databases/$(db)/documents/users/$(request.auth.uid))
        && get(/databases/$(db)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // users: o próprio lê; admin pode ler/escrever qualquer
    match /users/{uid} {
      allow read: if request.auth != null && (request.auth.uid == uid || isAdmin());
      allow write: if isAdmin();
    }

    // invites: admin gerencia; leitura opcional para logados
    match /invites/{email} {
      allow read: if request.auth != null;
      allow write, delete: if isAdmin();
    }
  }
}
-->
</body>
</html>
